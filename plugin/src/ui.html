<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Claude AI Bridge</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 12px;
      padding: 16px;
      color: #333;
      background: #fff;
    }

    .header {
      margin-bottom: 16px;
    }

    h1 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #666;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
      flex-shrink: 0;
    }

    .status-indicator.connected {
      background: #0fa958;
    }

    .status-indicator.error {
      background: #f24822;
    }

    .section {
      margin-bottom: 16px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .section-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
    }

    input:not([type="checkbox"]), select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 11px;
      background: #fff;
      color: #333;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 11px;
      color: #666;
    }

    button {
      width: 100%;
      padding: 8px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    button:hover {
      opacity: 0.9;
    }

    button.secondary {
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
    }

    .log {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 10px;
      padding: 8px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 160px;
      overflow-y: auto;
      color: #333;
    }

    .log-entry {
      margin-bottom: 4px;
      word-break: break-all;
    }

    .error-banner {
      background: #fff0f0;
      border: 1px solid #f24822;
      color: #c00;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-bottom: 12px;
      display: none;
    }

    /* Connection rows */
    .connection-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e5e5e5;
    }

    .connection-row:last-of-type {
      border-bottom: none;
    }

    .conn-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .conn-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
      flex-shrink: 0;
    }

    .conn-dot.connected { background: #0fa958; }
    .conn-dot.error { background: #f24822; }
    .conn-dot.connecting { background: #f0a400; }

    .conn-info {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .conn-name {
      font-size: 11px;
      font-weight: 600;
      color: #333;
    }

    .conn-port {
      font-size: 10px;
      color: #999;
    }

    /* Toggle switch */
    .toggle-label {
      position: relative;
      display: inline-block;
      width: 32px;
      height: 18px;
      cursor: pointer;
      margin: 0;
    }

    .toggle-label input[type="checkbox"] {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-slider {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #ccc;
      border-radius: 18px;
      transition: background 0.2s;
    }

    .toggle-slider:before {
      position: absolute;
      content: '';
      height: 14px;
      width: 14px;
      left: 2px;
      bottom: 2px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .toggle-label input:checked + .toggle-slider {
      background: #18a0fb;
    }

    .toggle-label input:checked + .toggle-slider:before {
      transform: translateX(14px);
    }

    /* Both-active warning */
    .warning-banner {
      display: none;
      margin-top: 10px;
      padding: 8px 10px;
      background: #fff8e6;
      border: 1px solid #f0c040;
      border-radius: 4px;
      font-size: 10px;
      color: #7a5500;
      line-height: 1.5;
    }

    .warning-banner strong {
      display: block;
      margin-bottom: 2px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div id="error-banner" class="error-banner"></div>

  <div class="header">
    <h1>Claude AI Bridge</h1>
    <div class="status">
      <div class="status-indicator" id="status-indicator"></div>
      <span id="status-text">Not connected</span>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Connections</div>

    <div class="connection-row">
      <div class="conn-left">
        <div class="conn-dot" id="cc-dot"></div>
        <div class="conn-info">
          <span class="conn-name">Claude Code</span>
          <span class="conn-port">port 3055</span>
        </div>
      </div>
      <label class="toggle-label">
        <input type="checkbox" id="cc-toggle" onchange="onCCToggle()">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="connection-row">
      <div class="conn-left">
        <div class="conn-dot" id="cd-dot"></div>
        <div class="conn-info">
          <span class="conn-name">Claude Desktop</span>
          <span class="conn-port">port 3056</span>
        </div>
      </div>
      <label class="toggle-label">
        <input type="checkbox" id="cd-toggle" onchange="onCDToggle()">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="warning-banner" id="both-warning">
      <strong>⚠️ Both clients active</strong>
      Claude Code and Claude Desktop can both send commands to this file at the same time. This is fine for independent tasks — just avoid having them edit the same elements simultaneously.
    </div>
  </div>

  <div class="section">
    <div class="section-title">Activity Log</div>
    <div class="log" id="log"></div>
    <button class="secondary" onclick="clearLog()" style="margin-top: 8px;">Clear Log</button>
  </div>

  <div class="section">
    <div class="section-title">Quick Actions</div>
    <button class="secondary" onclick="onTestClick()">Test Connection</button>
  </div>

  <script>
    window.onerror = function(msg, url, line, col, error) {
      showError('JS Error: ' + msg + ' (line ' + line + ')');
      return false;
    };

    window.onunhandledrejection = function(event) {
      showError('Unhandled promise rejection: ' + event.reason);
    };

    function showError(msg) {
      var banner = document.getElementById('error-banner');
      if (banner) {
        banner.style.display = 'block';
        banner.textContent = msg;
      }
      log(msg, 'error');
    }

    // State
    var wsCC = null;
    var wsCD = null;
    var isCCConnected = false;
    var isCDConnected = false;
    // Maps requestId → 'cc' | 'cd' so responses route back to the right server
    var pendingSource = {};

    // ── Logging ──────────────────────────────────────────────────────────────

    function log(message, type) {
      type = type || 'info';
      var logEl = document.getElementById('log');
      if (!logEl) return;

      var timestamp = new Date().toLocaleTimeString();
      var entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.textContent = '[' + timestamp + '] ' + message;

      if (type === 'error')   entry.style.color = '#f24822';
      else if (type === 'success') entry.style.color = '#0fa958';
      else if (type === 'warning') entry.style.color = '#cc8800';
      else entry.style.color = '#333';

      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clearLog() {
      var logEl = document.getElementById('log');
      if (logEl) logEl.innerHTML = '';
      log('Log cleared');
    }

    // ── Header status ─────────────────────────────────────────────────────────

    function updateHeaderStatus() {
      var indicator = document.getElementById('status-indicator');
      var text = document.getElementById('status-text');
      if (!indicator || !text) return;

      indicator.className = 'status-indicator';
      if (isCCConnected && isCDConnected) {
        indicator.classList.add('connected');
        text.textContent = 'CC + CD connected';
      } else if (isCCConnected) {
        indicator.classList.add('connected');
        text.textContent = 'Claude Code connected';
      } else if (isCDConnected) {
        indicator.classList.add('connected');
        text.textContent = 'Claude Desktop connected';
      } else {
        text.textContent = 'Not connected';
      }
    }

    function updateBothWarning() {
      var el = document.getElementById('both-warning');
      if (el) el.style.display = (isCCConnected && isCDConnected) ? 'block' : 'none';
    }

    // ── Dot helpers ───────────────────────────────────────────────────────────

    function setDot(id, state) {
      var dot = document.getElementById(id);
      if (dot) dot.className = 'conn-dot' + (state ? ' ' + state : '');
    }

    // ── Claude Code (3055) ────────────────────────────────────────────────────

    function onCCToggle() {
      var checked = document.getElementById('cc-toggle').checked;
      if (checked) connectCC(); else disconnectCC();
    }

    function connectCC() {
      var url = 'ws://localhost:3055';
      log('Connecting to Claude Code (' + url + ')...');
      setDot('cc-dot', 'connecting');

      try {
        wsCC = new WebSocket(url);
      } catch (e) {
        showError('CC WebSocket failed: ' + e.message);
        setDot('cc-dot', 'error');
        document.getElementById('cc-toggle').checked = false;
        return;
      }

      wsCC.onopen = function() {
        isCCConnected = true;
        log('Connected to Claude Code', 'success');
        setDot('cc-dot', 'connected');
        updateBothWarning();
        updateHeaderStatus();
      };

      wsCC.onclose = function(event) {
        log('Claude Code disconnected (code: ' + event.code + ')', 'warning');
        isCCConnected = false;
        wsCC = null;
        setDot('cc-dot', '');
        document.getElementById('cc-toggle').checked = false;
        updateBothWarning();
        updateHeaderStatus();
      };

      wsCC.onerror = function() {
        log('Claude Code error — is the MCP server running on port 3055?', 'error');
        setDot('cc-dot', 'error');
      };

      wsCC.onmessage = function(event) {
        try {
          var msg = JSON.parse(event.data);
          log('[CC] Received: ' + (msg.type || 'unknown'));
          if (msg.requestId) pendingSource[msg.requestId] = 'cc';
          parent.postMessage({ pluginMessage: msg }, '*');
        } catch (e) {
          log('[CC] Parse error: ' + e.message, 'error');
        }
      };
    }

    function disconnectCC() {
      log('Disconnecting from Claude Code...');
      if (wsCC) { wsCC.close(); wsCC = null; }
      isCCConnected = false;
      setDot('cc-dot', '');
      updateBothWarning();
      updateHeaderStatus();
    }

    // ── Claude Desktop (3056) ─────────────────────────────────────────────────

    function onCDToggle() {
      var checked = document.getElementById('cd-toggle').checked;
      if (checked) connectCD(); else disconnectCD();
    }

    function connectCD() {
      var url = 'ws://localhost:3056';
      log('Connecting to Claude Desktop (' + url + ')...');
      setDot('cd-dot', 'connecting');

      try {
        wsCD = new WebSocket(url);
      } catch (e) {
        showError('CD WebSocket failed: ' + e.message);
        setDot('cd-dot', 'error');
        document.getElementById('cd-toggle').checked = false;
        return;
      }

      wsCD.onopen = function() {
        isCDConnected = true;
        log('Connected to Claude Desktop', 'success');
        setDot('cd-dot', 'connected');
        updateBothWarning();
        updateHeaderStatus();
      };

      wsCD.onclose = function(event) {
        log('Claude Desktop disconnected (code: ' + event.code + ')', 'warning');
        isCDConnected = false;
        wsCD = null;
        setDot('cd-dot', '');
        document.getElementById('cd-toggle').checked = false;
        updateBothWarning();
        updateHeaderStatus();
      };

      wsCD.onerror = function() {
        log('Claude Desktop error — is the MCP server running on port 3056?', 'error');
        setDot('cd-dot', 'error');
      };

      wsCD.onmessage = function(event) {
        try {
          var msg = JSON.parse(event.data);
          log('[CD] Received: ' + (msg.type || 'unknown'));
          if (msg.requestId) pendingSource[msg.requestId] = 'cd';
          parent.postMessage({ pluginMessage: msg }, '*');
        } catch (e) {
          log('[CD] Parse error: ' + e.message, 'error');
        }
      };
    }

    function disconnectCD() {
      log('Disconnecting from Claude Desktop...');
      if (wsCD) { wsCD.close(); wsCD = null; }
      isCDConnected = false;
      setDot('cd-dot', '');
      updateBothWarning();
      updateHeaderStatus();
    }

    // ── Response routing ──────────────────────────────────────────────────────
    // When code.ts sends a response, route it back to whichever server
    // originated the request (tracked via requestId → source map).

    window.addEventListener('message', function(event) {
      try {
        var response = event.data && event.data.pluginMessage;
        if (!response) return;

        var source = response.requestId ? pendingSource[response.requestId] : null;
        if (response.requestId) delete pendingSource[response.requestId];

        var sent = false;

        if (source === 'cc' && wsCC && wsCC.readyState === WebSocket.OPEN) {
          wsCC.send(JSON.stringify(response));
          log('[CC] Sent: ' + (response.type || 'unknown'));
          sent = true;
        } else if (source === 'cd' && wsCD && wsCD.readyState === WebSocket.OPEN) {
          wsCD.send(JSON.stringify(response));
          log('[CD] Sent: ' + (response.type || 'unknown'));
          sent = true;
        } else {
          // No known source (e.g. ping) — broadcast to all open connections
          if (wsCC && wsCC.readyState === WebSocket.OPEN) {
            wsCC.send(JSON.stringify(response));
            log('[CC] Sent: ' + (response.type || 'unknown'));
            sent = true;
          }
          if (wsCD && wsCD.readyState === WebSocket.OPEN) {
            wsCD.send(JSON.stringify(response));
            log('[CD] Sent: ' + (response.type || 'unknown'));
            sent = true;
          }
        }

        if (!sent) {
          log('No active connection to forward response to', 'warning');
        }
      } catch (e) {
        log('Error forwarding message: ' + e.message, 'error');
      }
    });

    // ── Quick Actions ─────────────────────────────────────────────────────────

    function onTestClick() {
      if (!isCCConnected && !isCDConnected) {
        log('Not connected — enable at least one connection first', 'warning');
        return;
      }
      log('Sending ping...');
      parent.postMessage({ pluginMessage: { type: 'ping' } }, '*');
    }

    // ── Init ──────────────────────────────────────────────────────────────────
    log('Plugin UI loaded');
    log('WebSocket available: ' + (typeof WebSocket !== 'undefined'));
  </script>
</body>
</html>
